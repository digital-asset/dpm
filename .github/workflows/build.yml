name: build
on:
  push:

defaults:
  run:
    shell: bash -euo pipefail -c "source nix.source && exec bash {0}"

jobs:
  linux:
    runs-on: digital-asset-dpm
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: ./.github/actions/nix
      - run: go build -o target/ ./cmd/...
      - name: Run Go tests and generate in json format
        run: go test -json -v ./... | tee report.json
        continue-on-error: true
      - name: Publish Test Report
        uses: dorny/test-reporter@fe45e9537387dac839af0d33ba56eed8e24189e8
        with:
          name: Go Tests
          path: report.json
          reporter: golang-json
      - name: Run manual installation
        run: docs/src/public/manual-install.sh
      - uses: ./.github/actions/nsis
        with:
          bin-path: target/dpm


  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: cachix/cachix-action@v14
        with:
          name: digital-asset-dpm
      - name: 'Nix Setup'
        run: 'nix --extra-experimental-features "nix-command flakes" print-dev-env .#ci > nix.source'
        shell: bash
      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: '1.23.5'
      - run: go build -o target/ ./cmd/...
      - name: Run Go tests and generate in json format
        run: go test -json -v ./... | tee report.json
        continue-on-error: true
      - name: Publish Test Report
        uses: dorny/test-reporter@fe45e9537387dac839af0d33ba56eed8e24189e8
        with:
          name: Go Tests
          path: report.json
          reporter: golang-json
      - uses: ./.github/actions/nsis
        with:
          bin-path: target/dpm

  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: '1.23.5'
      - run: go build -o target/ ./cmd/...
        shell: bash
      - name: Run Go tests and generate in json format
        run: go test -json -v ./... | tee report.json
        continue-on-error: true
        shell: bash
      - name: Publish Test Report
        uses: dorny/test-reporter@fe45e9537387dac839af0d33ba56eed8e24189e8
        with:
          name: Go Tests
          path: report.json
          reporter: golang-json

  release-public:
    runs-on: digital-asset-dpm
    needs: 
      - windows
      - linux
    if: success() && startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/release
        with:
          repo: da-images/public
          flags: "--clean --skip=announce,publish,validate"
          key: ${{ secrets.DA_IMAGES }}

  release-public-unstable:
    runs-on: digital-asset-dpm
    needs: 
      - windows
      - linux
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: ./.github/actions/release
        with:
          repo: da-images/public-unstable
          flags: "--snapshot"
          key: ${{ secrets.DA_IMAGES }}
